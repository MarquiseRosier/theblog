<link rel="stylesheet" href="/style.css"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">

<script>
  (function(d) {
      var config = {
              // Todo: pull in the kit Id from the ACF field in the admin
              kitId: 'lkg3fdt',
              scriptTimeout: 3000,
              async: true
          },
          h=d.documentElement,t=setTimeout(function(){h.className=h.className.replace(/\bwf-loading\b/g,"")+" wf-inactive";},config.scriptTimeout),tk=d.createElement("script"),f=false,s=d.getElementsByTagName("script")[0],a;h.className+=" wf-loading";tk.src='https://use.typekit.net/'+config.kitId+'.js';tk.async=true;tk.onload=tk.onreadystatechange=function(){a=this.readyState;if(f||a&&a!="complete"&&a!="loaded")return;f=true;clearTimeout(t);try{Typekit.load(config)}catch(e){}};s.parentNode.insertBefore(tk,s)
  })(document);
</script>

<script src="/scrani.js"></script>
<script>

  /*
   * all pages
   */

  let nodes;
  const pageTypes = [
    'posts',
    'authors',
    'topics',
    'products',
  ];

  function getPageType(path) {
    const type = /^\/(.*)\//.exec(path);
    if (type) {
      const idx = pageTypes.indexOf(type[1]);
      if (idx !== -1) {
        return pageTypes[idx];
      }
    }
    return pageTypes[0]; // fall back to post
  }

  function createSVG(id) {
    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    const use = document.createElementNS('http://www.w3.org/2000/svg', 'use');
    use.setAttributeNS('http://www.w3.org/1999/xlink','href',`/icons.svg#${id}`);
    svg.appendChild(use);
    return svg;
  }

  function removeHeaderAndFooter () {
    // workaound until the ESI is fixed
    const header = document.querySelector("header");
    const footer = document.querySelector("footer");
    if (header.innerHTML == "/header.plain.html") header.innerHTML = "";
    if (footer.innerHTML == "/footer.plain.html") footer.innerHTML = "";
  }

  function getSection(index) {
    if (!nodes) nodes = document.querySelectorAll("main div");
    return index && nodes.length > index ? nodes[index] : nodes[nodes.length - 1];
  }

  /*
   * post page
   */

  function fetchAuthor() {
    const div = getSection(2);
    if (div) {
      const r = /^By (.*)\n*(.*)$/gmi.exec(div.innerText);
      const author = r && r.length > 0 ? r[1] : null;
      const date = r && r.length > 1 ? r[2] : ''
      if (author) {
        const xhr = new XMLHttpRequest();
        const fileName = author.replace(/\s/gm, '-').toLowerCase();
        const pageURL = '/authors/' + fileName + '.html';
        xhr.open('GET', pageURL);
        xhr.onload = function() {
          if (xhr.status != 200 || xhr.status != 304) {
            // try to get <main> elements and find author image
            const groups = /(^\s*<main>)((.|\n)*?)<\/main>/gm.exec(xhr.responseText);
            let main = groups.length > 2 ? groups[2] : null;
            if (main) {
              main = main.replace(fileName, '../authors/' + fileName);

              const avatarURL = /<img src="(.*?)">/.exec(main)[1];
              div.innerHTML = '<img src="' + avatarURL + '"> \
                <span class="post-author">by <a href="' + pageURL + '">' + author + '</a></span> \
                <span class="post-date">' + date + '</span> \
                ';
              div.classList.add('author');
            }
            // try to get the author's social links
            const socialLinks = /<p>(Social\: .*)<\/p>/gi.exec(xhr.responseText);
            if (socialLinks) {
              const p = document.createElement('p');
              p.innerHTML = socialLinks[1];
              fetchSocialLinks(p, div);
            }
          } else {
            console.log('Author not found...', xhr.response);
          }
        };
        xhr.send();
      }
    }
  }

  function fetchTopics() {
    const div = getSection();
    if (div) {
      const r = /^Topics\: (.*)$/gmi.exec(div.innerText);
      const topics = r.length > 0 ? r[1].split(',') : null;
      if (topics) {
        div.innerHTML = div.innerHTML.replace(`<p>${r[0]}</p>`, '');
        const topicsWrap = document.createElement('div');
        topicsWrap.className = 'default topics';
        topics.forEach((topic) => {
          topic = topic.trim();
          if (!topic) return;
          const btn = document.createElement('a');
          btn.href = `/topics/${topic.replace(/\s/gm, '-').toLowerCase()}.html`;
          btn.title = topic;
          btn.innerText = topic;

          topicsWrap.appendChild(btn);
        });
        div.parentNode.appendChild(topicsWrap);
      }
    }
  }

  /*
   * author page
   */

  const socialLinkTitles = [
    'Twitter',
    'LinkedIn',
    'Facebook',
    'YouTube',
  ];

  function getSocialLinkDetails(url) {
    let title;
    socialLinkTitles.forEach((t) => {
      if (!title && url.indexOf(t.toLowerCase()) > 0) {
        title = t;
      }
    });
    if (!title) title = 'Unknown';
    const type = title.toLowerCase();
    return { 
      title,
      type,
      className: `social-${type}`,
    };
  }

  function fetchSocialLinks(source, target) {
    if (!source) {
      source = getSection(0); // get the last section of the current document
    }
    if (!target) {
      target = source.parentNode;
    }
    if (source) {
      const r = /^Social\: (.*)$/gmi.exec(source.innerText);
      const links = r && r.length > 0 ? r[1].split(',') : null;
      if (links) {
        source.innerHTML = source.innerHTML.replace(/<p>Social\: .*<\/p>/gi, '');
        const socialWrap = document.createElement('div');
        socialWrap.className = 'default social';
        links.forEach((url) => {
          url = url.trim();
          if (!url) return;
          const { title, type, className } = getSocialLinkDetails(url);
          const link = document.createElement('a');
          link.className = className;
          link.title = title;
          link.href = url;
          link.appendChild(createSVG(type));
          socialWrap.appendChild(link);
        });
        target.insertBefore(socialWrap, source.nextSibling);
      }
    }
  }

  window.onload = function() {
    switch (getPageType(window.location.pathname)) {
      case pageTypes[0]: // posts
        fetchAuthor();
        fetchTopics();
      case pageTypes[1]: // authors
        fetchSocialLinks();
      case pageTypes[2]: // topics
      case pageTypes[3]: // products
      default: // all pages
        removeHeaderAndFooter();
    }
    scrani.onload();
  }

  window.onhashchange = function() {
    if (window.location.hash === "#menu") {
      document.querySelector("header div:nth-child(2)").style="display:block";
    } else {
      document.querySelector("header div:nth-child(2)").style="";
    }
  }

</script>
