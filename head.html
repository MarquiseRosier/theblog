<link rel="stylesheet" href="/style.css"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">

<script>
  (function(d) {
      var config = {
              // Todo: pull in the kit Id from the ACF field in the admin
              kitId: 'lkg3fdt',
              scriptTimeout: 3000,
              async: true
          },
          h=d.documentElement,t=setTimeout(function(){h.className=h.className.replace(/\bwf-loading\b/g,"")+" wf-inactive";},config.scriptTimeout),tk=d.createElement("script"),f=false,s=d.getElementsByTagName("script")[0],a;h.className+=" wf-loading";tk.src='https://use.typekit.net/'+config.kitId+'.js';tk.async=true;tk.onload=tk.onreadystatechange=function(){a=this.readyState;if(f||a&&a!="complete"&&a!="loaded")return;f=true;clearTimeout(t);try{Typekit.load(config)}catch(e){}};s.parentNode.insertBefore(tk,s)
  })(document);
</script>

<script src="/scrani.js"></script>
<script>
  function removeHeaderAndFooter () {
    // workaound until the ESI is fixed
    const header = document.querySelector("header");
    const footer = document.querySelector("footer");
    if (header.innerHTML == "/header.plain.html") header.innerHTML = "";
    if (footer.innerHTML == "/footer.plain.html") footer.innerHTML = "";
  }

  function getDiv(index) {
    const nodes = document.querySelectorAll("div.default");
    // TODO define edge cases, i.e. if number of divs is not what is 
    return nodes.length === 4 ? nodes[index] : null;
  }

  function fetchAuthor() {
    const div = getDiv(1);
    if (div) {
      const r = /by (.*)\n(.*)$/gm.exec(div.innerText);
      const author = r.length > 0 ? r[1] : null;
      const date = r.length > 1 ? r[2] : ''
      if (author) {
        const xhr = new XMLHttpRequest();
        const fileName = author.replace(/\s/gm, '-').toLowerCase();
        const pageURL = '/content/authors/' + fileName + '.html';
        xhr.open('GET', pageURL);
        xhr.onload = function() {
          if (xhr.status != 200 || xhr.status != 304) { // analyze HTTP status of the response
            const groups = /(^\s*<main>)((.|\n)*?)<\/main>/gm.exec(xhr.responseText);
            let main = groups.length > 2 ? groups[2] : null;
            if (main) {
              main = main.replace(fileName, '../authors/' + fileName);

              const avatarURL = /<img src="(.*?)">/.exec(main)[1];
              div.innerHTML = '<img src="' + avatarURL + '"> \
                <span class="post-author">by <a href="' + pageURL + '">' + author + '</a></span> \
                <span class="post-date">' + date + '</span> \
                ';
              div.classList.add('author');
            }
          } else {
            console.log('Author not found...', xhr.response);
          }
        };
        xhr.send();
      }
    }
  }

  window.onload = function() {
    removeHeaderAndFooter();
    fetchAuthor();
    scrani.onload();
  }

  window.onhashchange = function() {
    if (window.location.hash === "#menu") {
      document.querySelector("header div:nth-child(2)").style="display:block";
    } else {
      document.querySelector("header div:nth-child(2)").style="";
    }
  }

</script>
