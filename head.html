<link rel="stylesheet" href="/style.css"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">

<script>
  (function(d) {
      var config = {
              // Todo: pull in the kit Id from the ACF field in the admin
              kitId: 'lkg3fdt',
              scriptTimeout: 3000,
              async: true
          },
          h=d.documentElement,t=setTimeout(function(){h.className=h.className.replace(/\bwf-loading\b/g,"")+" wf-inactive";},config.scriptTimeout),tk=d.createElement("script"),f=false,s=d.getElementsByTagName("script")[0],a;h.className+=" wf-loading";tk.src='https://use.typekit.net/'+config.kitId+'.js';tk.async=true;tk.onload=tk.onreadystatechange=function(){a=this.readyState;if(f||a&&a!="complete"&&a!="loaded")return;f=true;clearTimeout(t);try{Typekit.load(config)}catch(e){}};s.parentNode.insertBefore(tk,s)
  })(document);
</script>

<script src="/scrani.js"></script>
<script>

  var nodes;

  function removeHeaderAndFooter () {
    // workaound until the ESI is fixed
    const header = document.querySelector("header");
    const footer = document.querySelector("footer");
    if (header.innerHTML == "/header.plain.html") header.innerHTML = "";
    if (footer.innerHTML == "/footer.plain.html") footer.innerHTML = "";
  }

  function getSection(index) {
    if (!nodes) nodes = document.querySelectorAll("main div");
    return index && nodes.length > index ? nodes[index] : nodes[nodes.length - 1];
  }

  function fetchAuthor() {
    const div = getSection(2);
    if (div) {
      const r = /^[Bb]y (.*)\n*(.*)$/gm.exec(div.innerText);
      const author = r.length > 0 ? r[1] : null;
      const date = r.length > 1 ? r[2] : ''
      if (author) {
        const xhr = new XMLHttpRequest();
        const fileName = author.replace(/\s/gm, '-').toLowerCase();
        const pageURL = '/authors/' + fileName + '.html';
        xhr.open('GET', pageURL);
        xhr.onload = function() {
          if (xhr.status != 200 || xhr.status != 304) {
            // try to get <main> elements and find author image
            const groups = /(^\s*<main>)((.|\n)*?)<\/main>/gm.exec(xhr.responseText);
            let main = groups.length > 2 ? groups[2] : null;
            if (main) {
              main = main.replace(fileName, '../authors/' + fileName);

              const avatarURL = /<img src="(.*?)">/.exec(main)[1];
              div.innerHTML = '<img src="' + avatarURL + '"> \
                <span class="post-author">by <a href="' + pageURL + '">' + author + '</a></span> \
                <span class="post-date">' + date + '</span> \
                ';
              div.classList.add('author');
            }
          } else {
            console.log('Author not found...', xhr.response);
          }
        };
        xhr.send();
      }
    }
  }

  function fetchTopics() {
    const div = getSection();
    if (div) {
      const r = /^Topics\: (.*)$/gm.exec(div.innerText);
      const topics = r.length > 0 ? r[1].split(', ') : null;
      if (topics) {
        div.innerText = div.innerText.replace(r[0], '');
        const topicsWrap = document.createElement('div');
        topicsWrap.className = 'default topics';
        // const btnWrap = document.createElement('div');
        topics.forEach((topic) => {
          const btn = document.createElement('a');
          btn.href = `/topics/${topic.replace(/\s/gm, '-').toLowerCase()}.html`;
          btn.title = topic;
          btn.innerText = topic;

          topicsWrap.appendChild(btn);
        });
        // topicsWrap.appendChild(btnWrap);
        div.parentNode.appendChild(topicsWrap);
      }
    }
  }

  function fetchProducts() {
    const div = getSection();
    const insertAfter = getSection(2);
    if (insertAfter) {
      const r = /^Products\: (.*)$/gm.exec(div.innerText);
      const products = r.length > 0 ? r[1].split(', ') : null;
      if (products) {
        div.innerText = div.innerText.replace(r[0], '');
        const productsWrap = document.createElement('div');
        productsWrap.className = 'default products';
        products.forEach((product) => {
          const productRef = product.replace(/\s/gm, '-').toLowerCase();

          const btn = document.createElement('a');
          btn.href = `https://www.adobe.com/${productRef}.html`;
          btn.title = product;

          const img = document.createElement('img');
          img.src = `/icons/${productRef}.svg`;
          img.alt = product;

          btn.appendChild(img);

          productsWrap.appendChild(btn);
        });
        insertAfter.after(productsWrap);
      }
    }
  }

  window.onload = function() {
    removeHeaderAndFooter();
    fetchAuthor();
    fetchTopics();
    fetchProducts();
    scrani.onload();
  }

  window.onhashchange = function() {
    if (window.location.hash === "#menu") {
      document.querySelector("header div:nth-child(2)").style="display:block";
    } else {
      document.querySelector("header div:nth-child(2)").style="";
    }
  }

</script>
